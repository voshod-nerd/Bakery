$(function () {

    $(".layzy").lazyload();


//КЛИК ПО ГАМБУРГЕРУ
    $('#nav-icon2').click(function () {
        $('html').toggleClass('popup_open');
        $(this).toggleClass('open');
        $('#menu').toggleClass('active');
    });

    //Проверка на корректность ввода кол-ва для товара
    $('body').on('change', '.number_input', function () {
        var value = +$(this).val();
        if (!isNumeric(value) || value < 1) {
            $(this).val('1');
        }
    });

    $('#basket_popup, body').on('click', '.count_minus', function (e) {
        var current_val = +$(e.target).parent().children('input').val();
        var input_element = $(e.target).parent().children('input');
        if (current_val > 1) {
            $(input_element).val(current_val - 1);
            $(input_element).change();
        }
    });
    $('#basket_popup, body').on('click', '.count_plus', function (e) {
        var current_val = +$(e.target).parent().children('input').val();
        var input_element = $(e.target).parent().children('input');
        $(input_element).val(current_val + 1);
        $(input_element).change();
    });

    function isNumeric(n) {
        return !isNaN(parseFloat(n)) && isFinite(n);
        // Метод isNaN пытается преобразовать переданный параметр в число. 
        // Если параметр не может быть преобразован, возвращает true, иначе возвращает false.
        // isNaN("12") // false 
    }


    $('.popup_form').click(function (e) {
        e.stopPropagation();
    });
    $('.popup_form_bg').click(function () {
        $(this).find('.popup_close').click();
    });


//ФОРМЫ

    $('.checkbox_agreement').click(function () {
        $(this).toggleClass('active');
        $(this).parents('form').find('button').toggleClass('lock');
    });

    function show_form() {
        $('#all_form').css('margin-top', '150px');
        $('#all_form_bg').fadeIn(200, function () {
            $('#all_form').fadeIn(150).animate({'margin-top': '20px'}, 250);
        });
        $('html').addClass('popup_open');
        $('#invalid_captcha').hide();

        if ($('#all_form input[name="action"]').val() === 'ask_question') {
            $('.for_goods_column').hide().find('[required]').removeAttr('required');
        } else {
            $('.for_goods_column').show().find('[required]').attr('required', 'required');
        }
    }


    //ЗАДАТЬ ВОПРОС
    $('#ask_question').click(function () {
        $('#all_form_title').text('Задать вопрос');
        $('#all_form input[name="action"]').val('ask_question');
        $('#all_form input[name="form_descr"]').val('Новый вопрос');
        $('#all_form label[for="user_text"]').html('ВОПРОС <sup>*</sup>').next().attr('required', 'required');
        show_form();

        $('#form_thanks .popup_title').text('Ваш вопрос отправлен');
    });


//ОБРАБОТКА УНИВЕРСАЛЬНОЙ ФОРМЫ
    $("#all_form form").submit(function (e) {
        e.preventDefault();
        if ($(this).find('button').hasClass('lock')) {
            alert('Примите условия пользовательского соглашения');
            return;
        }


        $.ajax({
            dataType: "json", type: "POST", url: "/order.php",
            data: {
                action: $('#all_form input[name="action"]').val(),
                form_descr: $('#all_form input[name="form_descr"]').val(),
//                user_name: $('#all_form input[name="user_name"]').val(),
//                user_phone: $('#all_form input[name="user_phone"]').val(),
//                user_email: $('#all_form input[name="user_email"]').val(),
                user_contacts: $('#all_form input[name="user_contacts"]').val(),
                user_text: $('#all_form textarea[name="user_text"]').val(),
                norobot: $('#all_form input[name="norobot"]').val(),
                url: location.href,
                basket_object: basket.getData()
            }
        }).done(function (data) {
            if (data.status === 'OK') {

                //.var action = $('#all_form input[name="action"]').val();


                $('#all_form form').each(function () {
                    $(this)[0].reset();
                });


                $('#all_form_bg').fadeOut(400, function () {
                    $('#form_thanks_bg').fadeIn(250);
                });
                reset_captcha();


//                // ЯД Цели
//
//                if (action === 'callback') {
//                    if ($('#callback').hasClass('active')) {
//                        GoJsTarget('CALLBACK_TOP');
//                    } else {
//                        GoJsTarget('CALLBACK_BOTTOM');
//                    }
//                } else if (action === 'order_from_one_click') {
//                    GoJsTarget('ORDER_ONE_CLICK');
//                } else if (action === 'order_from_basket') {
//                    GoJsTarget('ORDER_FROM_BASKET');
//                }


            }
            if (data.status === 'ERROR') {
                alert(data.msg);
            }

            if (data.status === 'INVALID_CAPTCHA') {
                $('#all_form .invalid_captcha').fadeIn(200);
                reset_captcha();
            }

        }).error(function (xhr, ajaxOptions, thrownError) {
            alert(xhr.status);
            alert(thrownError);
        });
    });

//    function GoJsTarget(target_name) {
//        if (typeof yaCounter51615776 !== 'undefined') {
//            yaCounter51615776.reachGoal(target_name);
//        }
//    }

    $('#norobot').change(function () {
        $('#all_form .invalid_captcha').fadeOut(200);
    });

    $("#all_form .captcha_img").click(function () {
        reset_captcha();
        $('#all_form .invalid_captcha').fadeOut(200);
    });

    function reset_captcha() {
        var now = new Date();
        res = '/captcha/captcha.php?' + now.getTime();
        $("#all_form .captcha_img").attr({src: res});
    }


    $('.popup_close, .to_continue').click(function () {
        $(this).parents('.popup_form').fadeOut(250, function () {
            $(this).parent('.popup_form_bg').fadeOut(250, function () {
                $(this).children().show();
                $('html').removeClass('popup_open');
            });

        });
    });


//    КОНЕЦ ФОРМЫ


    // Прокрутка таблиц для нешироких экранов
    if ($(window).width() <= 840) {
        var inner_width = $('.inner').width();
        $('table').each(function (i, e) {
            if ($(e).width() > inner_width) {
                $(e).wrap('<div class="table_wrap table_wrap_' + i + '" style="overflow-y: scroll;overflow-x: visible; padding-top: 25px"></div>');
                $('.table_wrap_' + i).prepend('<div style="font-size:12px;   line-height:1.3; padding:10px 0 5px;">Для просмотра всей таблицы двигайте пальцем по экрану влево и вправо</div>');
                $('.table_wrap_' + i).prepend('<div style="display: flex; display: -webkit-flex; display: -webkit-box; position: absolute; top: 0px; left: 50%; -webkit-transform: translateX(-50%); transform: translateX(-50%); align-items: center;"><span style="display:block; -webkit-transform: rotate(90deg); margin-right: 10px;  transform: rotate(90deg); width: 15px; height: 15px; background:url(/i/downwards-pointer_1.svg) no-repeat center;  background-size: 100%;"></span><span style="display:block; width: 20px; height: 20px; background:url(/i/finger-tap.svg) no-repeat center; background-size: 100%;"></span><span style="display:block; margin-left: 10px; -webkit-transform: rotate(-90deg);   transform: rotate(-90deg); width: 15px; height: 15px; background:url(/i/downwards-pointer_1.svg) no-repeat center;  background-size: 100%;"></span> </div>');
            }
        });
    }


//Клик по миниатюре картинки товара
    $('.miniature').click(function () {
        $('.miniature').removeClass('current');
        $(this).addClass('current');
        $('#product_img_main img').attr('src', $(this).data('img'));
    });


    //Выбор товарного предложения

    $('.product_offer').click(function () {
        if ($(this).hasClass('active')) {
            return;
        }
        $('.product_offer').removeClass('active');
        $(this).addClass('active');

        $('#product_price_val').text($(this).data('price'));
    });



// TO TOP
    function ToTop() {
        var $to_top = $('#to_top');
        if ($(window).scrollTop() > 100) {
            var xx = ($(window).width() - 1100) / 2;
            if (xx >= 0) {
                $to_top.css({'left': xx + 1170 + 10, 'right': 'auto'});
            } else {
                $to_top.css({'right': '20px', 'left': 'auto'});
            }
            $to_top.show();
            $('#help').show();
        } else {
            $to_top.hide();
            $('#help').hide();
        }
    }
    setInterval(ToTop, 200);
    $('#to_top').on('click', function () {
        $('html, body').animate({
            scrollTop: 0
        }, 500);
    });


    //CUSTOM SELECT
    $('.current_choose_item').click(function (event) {
        event.stopPropagation();
        $(this).next('.choose_items_list').fadeToggle(200);
    });
    $('.choose_item').click(function (event) {
        event.stopPropagation();
        $(this).parent().prev().children('.current_choose_item_title').text($(this).text());
        $('.choose_items_list').fadeOut(200);
        $(this).parent().children('.choose_item').removeClass('active');
        $(this).addClass('active');
        $(this).parents('form').find('.choose_item_input').val($(this).data('id'));

    });

    $('body').click(function () {
        $('.choose_items_list').fadeOut(200);
    });




    $('input[name="user_phone"]').mask("+7 (999) 999-99-99");
    
    
    //    var fixed = false;
//    $(window).scroll(function () {
//        if ($(window).scrollTop() > 190 && !fixed) {
//            $('.top_header').css({'position': 'fixed', 'top': '-150px'}).animate({'top': '0'}, 1000);
//            fixed = true;
//        }
//        else if($(window).scrollTop() === 0){
//            $('.top_header').css({'position': 'absolute', 'top': '0'});
//            fixed = false;
//        }
//    });

    
//    $("#search_input").autocomplete({
//        source: function (request, response) {
//
//            if ($("#search_input").val().length > 1) {
//
//                $.ajax({
//                    dataType: "json", type: "POST", url: "/scripts/ajax.php",
//                    data: {
//                        action: 'search',
//                        search: $('#search_input').val()
//                    },
//                    success: function (data) {
//                        autocomplete_data = data;
//                        response(data.title);
//                    }
//                });
//            }
//        },
//        open: function () {
//            $('.ui-menu-item').each(function (index, el) {
//                $(el).attr('data-href', autocomplete_data.url[index]);
//                $(el).prepend('<img class="ui_img" src="/core/image.php?path=' + autocomplete_data.image[index] + '&w=60&h=40&resize=1">');
//            });
//        }
//
//    });
//
//    $('body').on('click', '.ui-menu-item', function (e) {
//        location.href = $(e.target).data('href');
//    });
//
//
//    //HS
//    $('body').on('click', 'a.hs', function () {
//        if ($("div.hs_bg").size()) {
//            $("div.hs_bg").remove();
//            $('html').removeClass('popup_open');
//            return false;
//        } else {
//            var fimg = $(this).attr("href");
//            $(this).append('<div class="hs_bg" style="display: none; opacity:0; align-items: center;justify-content: space-around; position: fixed; background-color: #fff; z-index: 10000; top: 0; left: 0; width: 100%; height: 100%; text-align:center;">\n\
//                            <div class="popup_close basket_close"></div><img style="display:inline-block;vertical-align:middle; max-height:96%; max-width: 96%; border: 10px solid #fff; background: #fff;" src="' + fimg + '" alt="" />\n\
//                           </div>');
//            $("div.hs_bg").css('display', 'flex').animate({'opacity': 1}, 250);
//            $('html').addClass('popup_open');
//            return false;
//        }
//    });

//    //КЛИК ПО КЛАВИШЕ ESC
//    $(document).keydown(function (eventObject) {
//        if (eventObject.which === 27) { //Esc
//            $("div.hs_bg").fadeOut(200, function () {
//                $(this).remove();
//            });
//        }
//    });

// ЛИСТАЛКА КАРТИНОК ПРОДУКТА
//    $('body').on('click', '#miniatures_gallery_wrap .item_prev ', function (e) {
//        item_prev($(e.target).parents('#miniatures_gallery_wrap').find('.slider'));
//    });
//    $('body').on('click', '#miniatures_gallery_wrap .item_next ', function (e) {
//        item_next($(e.target).parents('#miniatures_gallery_wrap').find('.slider'));
//    });


});



